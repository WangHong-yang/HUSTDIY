#coding:utf-8
from __future__ import division
import os,os.path as opth
import Image
import glob
magic=[
'11111111111111111111111111111111111111111111111111111111100011111111100100111111110111011111110011100111111001110011111100111001111110011100111111001110011111100111001111111011101111111100100111111111000111111111111111111111111111111111111111111111111111111111',
'11111111111111111111111111111111111111111111111111111111100111111111000011111111111001111111111100111111111110011111111111001111111111100111111111110011111111111001111111111100111111111110011111111100000011111111111111111111111111111111111111111111111111111111',
'11111111111111111111111111111111111111111111111111111111000011111111011000111111011110011111111111001111111111100111111111110111111111110011111111111011111111111011111111111011110111111000000011111000000011111111111111111111111111111111111111111111111111111111',
'11111111111111111111111111111111111111111111111111111111000011111110011000111111011110011111111111001111111111001111111111000111111111110001111111111100111111111110011111111111001111110011001111111000001111111111111111111111111111111111111111111111111111111111',
'11111111111111111111111111111111111111111111111111111111111001111111111100111111111100011111111101001111111101100111111110110011111110111001111110111100111111000000001111111111001111111111100111111111110011111111111111111111111111111111111111111111111111111111',
'11111111111111111111111111111111111111111111111111111111100001111111110000111111110111111111111000111111111000001111111111100011111111111001111111111110111111111111011111111111101111111011101111111100001111111111111111111111111111111111111111111111111111111111',
'11111111111111111111111111111111111111111111111111111111111000111111110001111111110011111111110011111111111010001111111000110011111100111100111110011110011111001111001111100111100111111001100111111110000111111111111111111111111111111111111111111111111111111111',
'11111111111111111111111111111111111111111111111111111111000000011111100000011111101111101111111111101111111111110111111111111011111111111011111111111101111111111101111111111110111111111111011111111111011111111111111111111111111111111111111111111111111111111111',
'11111111111111111111111111111111111111111111111111111111000011111111001110011111001111001111100111100111111000100111111110001111111111000011111111011100111111001111001111100111100111111001100111111110000111111111111111111111111111111111111111111111111111111111',
'11111111111111111111111111111111111111111111111111111111000011111111001100111111001111001111100111100111110011110011111001111001111110011100111111100000111111111110011111111110011111111110011111111000111111111111111111111111111111111111111111111111111111111111']
w,h=13,20
loff=4#left offset
code_len=5
#god knows
BG_GREEN,BG_RED=160,160.1

def _get_binary(image,mode):
    bin=[""]*code_len
    im=Image.open(image)
    for i in range(code_len):
        bin[i]=map(lambda i: 0 if i < mode else 1, im.crop((loff+w*i,0,loff+w*i+w,20)).convert('L').getdata())
    return bin

def comp(lst1,lst2,width=w*h):
    cnt=0
    for k in range(width):
        if lst1[k]==int(lst2[k]):
            cnt+=1
    return cnt

getcmp=lambda lst,top=5:sorted(['%d:%d'%(comp(lst,magic[i]),i) for i in range(10)],reverse=True)[:top]

def get_code(img,mode=BG_GREEN):#filename or stream
    t2=_get_binary(img,mode)
    res=''
    for i in range(code_len):
        gv=getcmp(t2[i],3)
        res+=gv[0][-1]
        #print '\n'.join(gv)
        #print '------'
    return res

if __name__=='__main__':
    print get_code(open(r'D:\Dev\Python\Workspace\PIL-exp\HUB\test_img\\06038.jpg','rb'))